name: Release build

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Optional tag to use for the release (e.g. v1.2.3). When omitted the workflow will use the ref name.'
        required: false

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    outputs:
      version: ${{ steps.build.outputs.version }}
      zip: ${{ steps.build.outputs.zip }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build release ZIP and generate installer launcher
        id: build
        shell: pwsh
        env:
          RELEASE_TAG: ${{ github.event.inputs.release_tag }}
          REF_NAME: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
        run: |
          $ErrorActionPreference = 'Stop'

          # Determine release tag to use as version. Prefer explicit input, otherwise use the ref name.
          $tag = $env:RELEASE_TAG
          if ([string]::IsNullOrWhiteSpace($tag)) { $tag = $env:REF_NAME }
          if ([string]::IsNullOrWhiteSpace($tag) -or $tag -eq 'main') { throw 'Release tag is empty or invalid. Provide a tag via workflow_dispatch input `release_tag` or run on a tag ref.' }

          $outDir = Join-Path $PWD 'out'
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null

          $zipName = "Hoteldruid-PHPDesktop-$tag.zip"
          $zipPath = Join-Path $outDir $zipName

          # Files to include in the ZIP (search common locations)
          $names = @('install_release.ps1','uninstall_release.ps1','phpdesktop-custom-settings.json','msvcp140.dll','vcruntime140.dll','vcruntime140_1.dll')
          $payload = @()
          foreach ($n in $names) {
            $candidates = @(Join-Path $PWD $n, Join-Path $PWD "vc_runtime_dlls\$n")
            $found = $candidates | Where-Object { Test-Path $_ } | Select-Object -First 1
            if (-not $found) { throw "Required payload file missing: $n (looked in: $($candidates -join ', '))" }
            $payload += $found
          }

          # Create the zip (idempotent)
          if (Test-Path $zipPath) { Remove-Item -Force $zipPath }
          Write-Host "Creating ZIP $zipPath containing: $($payload -join ', ')"
          Compress-Archive -Path $payload -DestinationPath $zipPath -Force
          if (-not (Test-Path $zipPath)) { throw "Failed to create ZIP: $zipPath" }

          # Generate install.ps1 launcher. It downloads the versioned ZIP from this repo's release and runs install_release.ps1 from it.
          $repo = $env:REPO
          $zipAsset = $zipName

          # Ensure `install.ps1` exists in repo root (user-managed)
          $installInRepo = Join-Path $PWD 'install.ps1'
          if (-not (Test-Path $installInRepo)) { throw "install.ps1 not found in repository root. Add the launcher script to the repo as requested." }

          # Set outputs for downstream use
          "version=$tag" >> $env:GITHUB_OUTPUT
          "zip=$zipPath" >> $env:GITHUB_OUTPUT

      - name: Create GitHub release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.build.outputs.version }}
          name: Hoteldruid-PHPDesktop-${{ steps.build.outputs.version }}
          files: |
            ${{ steps.build.outputs.zip }}
            ${{ steps.build.outputs.install }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

