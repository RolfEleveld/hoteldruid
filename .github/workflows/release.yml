name: Release build

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    outputs:
      version: ${{ steps.build.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build phpdesktop package
        id: build
        shell: pwsh
        run: |
          $version = "3.0.7.${{ github.run_number }}"
          $outDir = Join-Path $PWD 'out'
          mkdir $outDir -Force | Out-Null
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null

          # The final EXE name
          $exePath = Join-Path $outDir "Hoteldruid-PHPDesktop-$version.exe"

          # Copy SED file into output folder so we can modify it
          Copy-Item "$PWD/Hoteldruid-PHPDesktop-Setup.SED" "$outDir/Hoteldruid-PHPDesktop-Setup.SED" -Force

          # Update the SED file to output the versioned EXE and point SourceFiles to the current repo
          $sedPath = "$outDir/Hoteldruid-PHPDesktop-Setup.SED"
          $content = Get-Content $sedPath -Raw -ErrorAction Stop -Encoding UTF8
          $lines = $content -split "\r?\n"
          # Ensure TargetName is set (prefer the entry under [Strings])
          $stringsLineObj = $lines | Select-String -Pattern '^\[Strings\]' -SimpleMatch | Select-Object -First 1
          if ($stringsLineObj) {
            $start = $stringsLineObj.LineNumber
            for ($i = $start; $i -lt $lines.Length; $i++) {
              if ($lines[$i] -match '^TargetName=') { $lines[$i] = "TargetName=$exePath"; break }
            }
          }

          # Force SourceFiles0/1 to the current workspace so IExpress can find the files
          $sourceRoot = $PWD.Path
          $sourceRootSlash = $sourceRoot + '\\'
          for ($i=0; $i -lt $lines.Length; $i++) {
            if ($lines[$i] -match '^SourceFiles0=') { $lines[$i] = "SourceFiles0=$sourceRootSlash" }
            if ($lines[$i] -match '^SourceFiles1=') { $lines[$i] = "SourceFiles1=$sourceRootSlash" }
          }
          ($lines -join "`r`n") | Set-Content -Path $sedPath -Encoding UTF8

          # Verify iexpress exists
          $iexpressCmd = Get-Command iexpress.exe -ErrorAction SilentlyContinue
          if (-not $iexpressCmd) {
            Write-Host 'ERROR: iexpress.exe not found on runner.'
            throw 'iexpress.exe not available'
          }
          Write-Host "IExpress command: $($iexpressCmd.Source)"

          # Show which files will be referenced from SourceFiles entries
          Write-Host '--- Files referenced by SED (checking existence) ---'
          $fileEntries = $lines | Where-Object { $_ -match '^FILE\d+=' } | ForEach-Object { ($_ -split '=')[1].Trim('"') }
          foreach ($f in $fileEntries) {
            $p = Join-Path $sourceRoot $f
            if (Test-Path $p) { Write-Host "FOUND: $p" } else { Write-Host "MISSING: $p" }
          }

          # Run IExpress (capture exit code)
          $proc = Start-Process -FilePath iexpress.exe -ArgumentList "/N `"$sedPath`"" -Wait -NoNewWindow -PassThru
          Write-Host "IExpress exit code: $($proc.ExitCode)"

          # Debug: show SED and output directory contents
          Write-Host '--- SED content ---'
          Get-Content $sedPath | ForEach-Object { Write-Host $_ }
          Write-Host '--- Out directory contents ---'
          Get-ChildItem -Path $outDir -Recurse -Force | ForEach-Object { Write-Host $_.FullName }

          # Output variables for later steps; fail with clear diagnostics if EXE not produced
          if (Test-Path $exePath) {
            $resolved = (Resolve-Path $exePath).Path
            "version=$version" >> $env:GITHUB_OUTPUT
            "exe=$resolved" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "ERROR: Expected EXE not found at $exePath"
            Write-Host 'Listing out directory for troubleshooting:'
            Get-ChildItem -Path $outDir -Recurse -Force | ForEach-Object { Write-Host $_.FullName }
            throw "IExpress did not create the expected EXE: $exePath"
          }
        
      - name: Compute SHA256 for winget
        id: hash
        shell: pwsh
        run: |
          $hash = (Get-FileHash -Path '${{ steps.build.outputs.exe }}' -Algorithm SHA256).Hash
          "sha256=$hash" >> $env:GITHUB_OUTPUT

      - name: Generate winget manifests
        id: manifests
        shell: pwsh
        run: |
          $version = '${{ steps.build.outputs.version }}'
          $sha = '${{ steps.hash.outputs.sha256 }}'
          $repo = '${{ github.repository }}'
          $asset = "hoteldruid-PHPDesktop-$version.exe"
          $installUrl = "https://github.com/$repo/releases/download/v$version/$asset"
          $base = Join-Path $PWD "manifests/h/HotelDruid/PHPDesktop/$version"
          New-Item -ItemType Directory -Force -Path $base | Out-Null

          $installer = @"
          PackageIdentifier: HotelDruid.PHPDesktop
          PackageVersion: $version
          InstallerType: exe
          Installers:
            - Architecture: x64
              InstallerUrl: $installUrl
              InstallerSha256: $sha
              InstallerSwitches:
                Silent: ""
                SilentWithProgress: ""
          ManifestType: installer
          ManifestVersion: 1.6.0
          "@
          Set-Content -Path (Join-Path $base 'HotelDruid.PHPDesktop.installer.yaml') -Value $installer -Encoding UTF8

          $localeEn = @"
          PackageIdentifier: HotelDruid.PHPDesktop
          PackageVersion: $version
          PackageLocale: en-US
          Publisher: Rolf Eleveld
          PackageName: HotelDruid PHPDesktop
          ShortDescription: HotelDruid desktop installer (PHP Desktop)
          Description: HotelDruid is an open source hotel management software that runs on a web server. This package provides a desktop installer using PHP Desktop, allowing you to run HotelDruid as a standalone desktop application without needing a separate web server installation.
          License: AGPL-3.0
          "@
          Set-Content -Path (Join-Path $base 'HotelDruid.PHPDesktop.locale.en-US.yaml') -Value $localeEn -Encoding UTF8

          $localeEs = @"
          PackageIdentifier: HotelDruid.PHPDesktop
          PackageVersion: $version
          PackageLocale: es-ES
          Publisher: Rolf Eleveld
          PackageName: HotelDruid
          ShortDescription: Instalador de escritorio HotelDruid (PHP Desktop)
          Description: HotelDruid es un software de gestión hotelera de código abierto que se ejecuta en un servidor web. Este paquete proporciona un instalador de escritorio utilizando PHP Desktop, lo que le permite ejecutar HotelDruid como una aplicación de escritorio independiente sin necesidad de una instalación de servidor web por separado.
          License: AGPL-3.0
          "@
          Set-Content -Path (Join-Path $base 'HotelDruid.PHPDesktop.locale.es-ES.yaml') -Value $localeEs -Encoding UTF8

          $localeIt = @"
          PackageIdentifier: HotelDruid.PHPDesktop
          PackageVersion: $version
          PackageLocale: it-IT
          Publisher: Rolf Eleveld
          PackageName: HotelDruid
          ShortDescription: Programma di installazione desktop HotelDruid (PHP Desktop)
          Description: HotelDruid è un software di gestione alberghiera open source che funziona su un server web. Questo pacchetto fornisce un programma di installazione desktop utilizzando PHP Desktop, che consente di eseguire HotelDruid come applicazione desktop autonoma senza la necessità di una installazione separata del server web.
          License: AGPL-3.0
          "@
          Set-Content -Path (Join-Path $base 'HotelDruid.PHPDesktop.locale.it-IT.yaml') -Value $localeIt -Encoding UTF8

          $versionManifest = @"
          PackageIdentifier: HotelDruid.PHPDesktop
          PackageVersion: $version
          DefaultLocale: en-US
          ManifestType: version
          ManifestVersion: 1.6.0
          "@
          Set-Content -Path (Join-Path $base 'HotelDruid.PHPDesktop.yaml') -Value $versionManifest -Encoding UTF8

      - name: Upload winget manifests
        uses: actions/upload-artifact@v4
        with:
          name: winget-manifests-${{ steps.build.outputs.version }}
          path: manifests/h/HotelDruid/PHPDesktop/${{ steps.build.outputs.version }}
          if-no-files-found: error

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: hoteldruid-PHPDesktop-${{ steps.build.outputs.version }}
          path: ${{ steps.build.outputs.zip }}
          if-no-files-found: error

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.build.outputs.version }}
          name: hoteldruid-PHPDesktop-${{ steps.build.outputs.version }}
          files: ${{ steps.build.outputs.zip }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  submit-winget-pr:
    needs: build-and-release
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.build-and-release.outputs.version }}
      WINGET_FORK: RolfEleveld/winget-pkgs
      WINGET_UPSTREAM: microsoft/winget-pkgs
      BASE_BRANCH: master
    steps:
      - name: Download winget manifests artifact
        uses: actions/download-artifact@v4
        with:
          name: winget-manifests-${{ needs.build-and-release.outputs.version }}
          path: winget-manifests

      - name: Clone winget-pkgs fork
        env:
          PAT: ${{ secrets.WINGET_PAT }}
        run: |
          git clone https://$PAT@github.com/$WINGET_FORK.git
          cd winget-pkgs
          git remote add upstream https://github.com/$WINGET_UPSTREAM.git
          git fetch upstream $BASE_BRANCH
          git checkout -B hoteldruid-phpdesktop-$VERSION upstream/$BASE_BRANCH

      - name: Copy manifests into fork
        run: |
          mkdir -p winget-pkgs/manifests/h/HotelDruid/PHPDesktop/${{ needs.build-and-release.outputs.version }}
          cp -r winget-manifests/. winget-pkgs/manifests/h/HotelDruid/PHPDesktop/${{ needs.build-and-release.outputs.version }}/

      - name: Commit changes
        env:
          GIT_AUTHOR_NAME: github-actions
          GIT_AUTHOR_EMAIL: github-actions@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions
          GIT_COMMITTER_EMAIL: github-actions@users.noreply.github.com
        run: |
          cd winget-pkgs
          git status --short
          if git diff --quiet && git diff --cached --quiet; then
            echo "No manifest changes; skipping PR."
            exit 0
          fi
          git add manifests/h/HotelDruid/PHPDesktop/${{ needs.build-and-release.outputs.version }}
          git commit -m "Add HotelDruid.PHPDesktop ${{ needs.build-and-release.outputs.version }}"

      - name: Push branch to fork
        env:
          PAT: ${{ secrets.WINGET_PAT }}
        run: |
          cd winget-pkgs
          git push https://$PAT@github.com/$WINGET_FORK.git hoteldruid-phpdesktop-${{ needs.build-and-release.outputs.version }} --force

      # - name: Create PR to winget-pkgs upstream
      #   env:
      #     GH_TOKEN: ${{ secrets.WINGET_PAT }}
      #   run: |
      #     cd winget-pkgs
      #     gh pr create \
      #       --repo $WINGET_UPSTREAM \
      #       --head RolfEleveld:hoteldruid-phpdesktop-${{ needs.build-and-release.outputs.version }} \
      #       --base $BASE_BRANCH \
      #       --title "Add HotelDruid.PHPDesktop ${{ needs.build-and-release.outputs.version }}" \
      #       --body "Automated submission for HotelDruid.PHPDesktop ${{ needs.build-and-release.outputs.version }}"

