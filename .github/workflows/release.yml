name: Release build

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    outputs:
      version: ${{ steps.build.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build phpdesktop package
        id: build
        shell: pwsh
        run: |
          $version = "3.0.7.${{ github.run_number }}"
          $outDir = Join-Path $PWD 'out'
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null

          # The final EXE name
          $exePath = Join-Path $outDir "Hoteldruid-PHPDesktop-$version.exe"
          $sedPath = "$PWD/Hoteldruid-PHPDesktop-Setup.SED"

          # Run IExpress (capture exit code)
          $sedPath = "$PWD/Hoteldruid-PHPDesktop-Setup.SED"
          iexpress.exe /N "$sedPath"
          $rc = $LASTEXITCODE
          Write-Host "IExpress exit code: $rc"

          # Wait for teh exe to appear (sometimes delayed)
          $counter = 0
          while (-not (Test-Path "$PWD/Hoteldruid-PHPDesktop-Setup.exe")) {
            Start-Sleep -Seconds 1
            $counter++
            if ($counter -gt 10) {
              throw "Timeout waiting for IExpress to produce EXE"
            }
          }
          # Debug: show SED and output directory contents
          Move-Item -Path "$PWD/Hoteldruid-PHPDesktop-Setup.exe" -Destination $exePath
          Write-Host '--- Out directory contents ---'
          Get-ChildItem -Path $outDir -Recurse -Force | ForEach-Object { Write-Host $_.FullName }

          # Output variables for later steps; fail with clear diagnostics if EXE not produced
          if (Test-Path $exePath) {
            $resolved = (Resolve-Path $exePath).Path
            "version=$version" >> $env:GITHUB_OUTPUT
            "exe=$resolved" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "ERROR: Expected EXE not found at $exePath"
            Write-Host 'Listing out directory for troubleshooting:'
            Get-ChildItem -Path $outDir -Recurse -Force | ForEach-Object { Write-Host $_.FullName }
            throw "IExpress did not create the expected EXE: $exePath"
          }
        
      - name: Compute SHA256 for winget
        id: hash
        shell: pwsh
        run: |
          $hash = (Get-FileHash -Path '${{ steps.build.outputs.exe }}' -Algorithm SHA256).Hash
          "sha256=$hash" >> $env:GITHUB_OUTPUT

      - name: Generate winget manifests
        id: manifests
        shell: pwsh
        run: |
          $version = '${{ steps.build.outputs.version }}'
          $sha = '${{ steps.hash.outputs.sha256 }}'
          $repo = '${{ github.repository }}'
          $asset = "hoteldruid-PHPDesktop-$version.exe"
          $installUrl = "https://github.com/$repo/releases/download/v$version/$asset"
          $base = Join-Path $PWD "manifests"          
          New-Item -ItemType Directory -Force -Path $base | Out-Null

          $installer = @"
          PackageIdentifier: HotelDruid.PHPDesktop
          PackageVersion: $version
          InstallerType: exe
          Installers:
            - Architecture: x64
              InstallerUrl: $installUrl
              InstallerSha256: $sha
              InstallerSwitches:
                Silent: "-Quiet"
                SilentWithProgress: "-Quiet"
          ManifestType: installer
          ManifestVersion: 1.6.0
          "@
          Set-Content -Path (Join-Path $base 'HotelDruid.PHPDesktop.installer.yaml') -Value $installer -Encoding UTF8

          $localeEn = @"
          PackageIdentifier: HotelDruid.PHPDesktop
          PackageVersion: $version
          PackageLocale: en-US
          Publisher: Rolf Eleveld
          PackageName: HotelDruid PHPDesktop
          ShortDescription: HotelDruid desktop installer (PHP Desktop)
          Description: HotelDruid is an open source hotel management software that runs on a web server. This package provides a desktop installer using PHP Desktop, allowing you to run HotelDruid as a standalone desktop application without needing a separate web server installation.
          License: AGPL-3.0
          ManifestType: defaultLocale
          ManifestVersion: 1.6.0
          "@
          Set-Content -Path (Join-Path $base 'HotelDruid.PHPDesktop.locale.en-US.yaml') -Value $localeEn -Encoding UTF8

          $localeEs = @"
          PackageIdentifier: HotelDruid.PHPDesktop
          PackageVersion: $version
          PackageLocale: es-ES
          Publisher: Rolf Eleveld
          PackageName: HotelDruid
          ShortDescription: Instalador de escritorio HotelDruid (PHP Desktop)
          Description: HotelDruid es un software de gestión hotelera de código abierto que se ejecuta en un servidor web. Este paquete proporciona un instalador de escritorio utilizando PHP Desktop, lo que le permite ejecutar HotelDruid como una aplicación de escritorio independiente sin necesidad de una instalación de servidor web por separado.
          License: AGPL-3.0
          ManifestType: locale
          ManifestVersion: 1.6.0
          "@
          Set-Content -Path (Join-Path $base 'HotelDruid.PHPDesktop.locale.es-ES.yaml') -Value $localeEs -Encoding UTF8

          $localeIt = @"
          PackageIdentifier: HotelDruid.PHPDesktop
          PackageVersion: $version
          PackageLocale: it-IT
          Publisher: Rolf Eleveld
          PackageName: HotelDruid
          ShortDescription: Programma di installazione desktop HotelDruid (PHP Desktop)
          Description: HotelDruid è un software di gestione alberghiera open source che funziona su un server web. Questo pacchetto fornisce un programma di installazione desktop utilizzando PHP Desktop, che consente di eseguire HotelDruid come applicazione desktop autonoma senza la necessità di una installazione separata del server web.
          License: AGPL-3.0
          ManifestType: locale
          ManifestVersion: 1.6.0
          "@
          Set-Content -Path (Join-Path $base 'HotelDruid.PHPDesktop.locale.it-IT.yaml') -Value $localeIt -Encoding UTF8

          $versionManifest = @"
          PackageIdentifier: HotelDruid.PHPDesktop
          PackageVersion: $version
          DefaultLocale: en-US
          ManifestType: version
          ManifestVersion: 1.6.0
          "@
          Set-Content -Path (Join-Path $base 'HotelDruid.PHPDesktop.yaml') -Value $versionManifest -Encoding UTF8

      - name: Upload winget manifests
        uses: actions/upload-artifact@v4
        with:
          name: winget-manifests-${{ steps.build.outputs.version }}
          path: manifests
          if-no-files-found: error

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: hoteldruid-PHPDesktop-${{ steps.build.outputs.version }}
          path: ${{ steps.build.outputs.exe }}
          if-no-files-found: error

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.build.outputs.version }}
          name: hoteldruid-PHPDesktop-${{ steps.build.outputs.version }}
          files: ${{ steps.build.outputs.exe }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  submit-winget-pr:
    needs: build-and-release
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.build-and-release.outputs.version }}
      WINGET_FORK: RolfEleveld/winget-pkgs
      WINGET_UPSTREAM: microsoft/winget-pkgs
      BASE_BRANCH: master
    steps:
      - name: Download winget manifests artifact
        uses: actions/download-artifact@v4
        with:
          name: winget-manifests-${{ needs.build-and-release.outputs.version }}
          path: manifests

      - name: Clone winget-pkgs fork
        env:
          PAT: ${{ secrets.WINGET_PAT }}
        run: |
          git clone https://$PAT@github.com/$WINGET_FORK.git
          cd winget-pkgs
          git remote add upstream https://github.com/$WINGET_UPSTREAM.git
          git fetch upstream $BASE_BRANCH
          git checkout -B hoteldruid-phpdesktop-$VERSION upstream/$BASE_BRANCH

      - name: Copy manifests into fork
        run: |
          set -euo pipefail
          echo '--- Source manifests (before copy) ---'
          if [ -d manifests ]; then
            find manifests -type f -maxdepth 5 -print || true
          else
            echo 'ERROR: manifests directory missing'
            exit 1
          fi
          mkdir -p winget-pkgs/manifests/h/HotelDruid/PHPDesktop/${{ needs.build-and-release.outputs.version }}
          echo 'Copying manifests...'
          cp -a manifests/. winget-pkgs/manifests/h/HotelDruid/PHPDesktop/${{ needs.build-and-release.outputs.version }}/
          echo "Copy exit: $?"
          echo '--- Destination manifests (after copy) ---'
          find winget-pkgs/manifests/h/HotelDruid/PHPDesktop/${{ needs.build-and-release.outputs.version }} -type f -print || true
          cnt=$(find winget-pkgs/manifests/h/HotelDruid/PHPDesktop/${{ needs.build-and-release.outputs.version }} -type f | wc -l)
          echo "Files copied: $cnt"
          if [ "$cnt" -eq "0" ]; then
            echo 'ERROR: No files were copied into the fork manifest path'
            ls -la winget-pkgs/manifests || true
            exit 1
          fi

      - name: Commit changes
        env:
          GIT_AUTHOR_NAME: github-actions
          GIT_AUTHOR_EMAIL: github-actions@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions
          GIT_COMMITTER_EMAIL: github-actions@users.noreply.github.com
        run: |
          set -euo pipefail
          cd winget-pkgs
          echo '--- Repo root ---'
          pwd
          echo '--- Check target manifest dir ---'
          ls -la manifests/h/HotelDruid/PHPDesktop/${{ needs.build-and-release.outputs.version }} || true
          echo '--- Git status (including untracked) ---'
          git status --porcelain=1 -uall || true
          echo '--- Git untracked files (top) ---'
          git ls-files --others --exclude-standard | sed -n '1,50p' || true

          # Add files (use -f if necessary) and show return codes
          echo 'Adding files to index...'
          git add -A manifests/h/HotelDruid/PHPDesktop/${{ needs.build-and-release.outputs.version }}
          echo "git add exit: $?"

          echo '--- Staged files ---'
          git diff --name-only --cached || true
          echo '--- Staged files with mode ---'
          git ls-files --stage manifests/h/HotelDruid/PHPDesktop/${{ needs.build-and-release.outputs.version }} || true

          if git diff --quiet && git diff --cached --quiet; then
            echo "No manifest changes; skipping PR."
            exit 0
          fi

          echo 'Committing changes...'
          git commit -m "Add HotelDruid.PHPDesktop ${{ needs.build-and-release.outputs.version }}" || {
            echo 'git commit failed or nothing to commit';
            git status --porcelain=1 -uall || true
            exit 1
          }

      - name: Push branch to fork
        env:
          PAT: ${{ secrets.WINGET_PAT }}
        run: |
          cd winget-pkgs
          git push https://$PAT@github.com/$WINGET_FORK.git hoteldruid-phpdesktop-${{ needs.build-and-release.outputs.version }} --force

      # - name: Create PR to winget-pkgs upstream
      #   env:
      #     GH_TOKEN: ${{ secrets.WINGET_PAT }}
      #   run: |
      #     cd winget-pkgs
      #     gh pr create \
      #       --repo $WINGET_UPSTREAM \
      #       --head RolfEleveld:hoteldruid-phpdesktop-${{ needs.build-and-release.outputs.version }} \
      #       --base $BASE_BRANCH \
      #       --title "Add HotelDruid.PHPDesktop ${{ needs.build-and-release.outputs.version }}" \
      #       --body "Automated submission for HotelDruid.PHPDesktop ${{ needs.build-and-release.outputs.version }}"

