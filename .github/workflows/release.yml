name: Release build

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build phpdesktop package
        id: build
        shell: pwsh
        run: |
          $version = "3.0.7.${{ github.run_number }}"
          $outDir = Join-Path $PWD 'out'
          $zipPath = Join-Path $outDir "hoteldruid-PHPDesktop-$version.zip"
          ./build_deployment_package.ps1 -RepoRoot $PWD -OutputDir $outDir -OutputZip $zipPath
          $resolved = (Resolve-Path $zipPath).Path
          "version=$version" >> $env:GITHUB_OUTPUT
          "zip=$resolved" >> $env:GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: hoteldruid-PHPDesktop-${{ steps.build.outputs.version }}
          path: ${{ steps.build.outputs.zip }}
          if-no-files-found: error

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.build.outputs.version }}
          name: hoteldruid-PHPDesktop-3.0.7.${{ github.run_number }}
          files: ${{ steps.build.outputs.zip }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
